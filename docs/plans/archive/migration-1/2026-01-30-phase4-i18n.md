# Phase 4: i18n Configuration

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Configure next-intl for internationalization with Next.js 16 App Router.

**Files:**
- Create: `apps/web/src/middleware.ts`
- Create: `apps/web/src/i18n/routing.ts`
- Modify: `apps/web/next.config.ts` (add next-intl plugin)
- Modify: `apps/web/src/i18n/request.ts`
- Keep: `apps/web/src/lib/core/navigation.ts` (existing routing)
- Keep: `apps/web/src/lib/core/proxy.ts` (existing proxy)

---

## Task 1: Create i18n Routing Configuration

**Step 1: Create routing.ts**

Create file `apps/web/src/i18n/routing.ts`:

```typescript
import { defineRouting } from 'next-intl/routing';
import { locales, defaultLocale } from '@/config/i18n';

export const routing = defineRouting({
  // A list of all locales that are supported
  locales: locales,

  // Used when no locale matches
  defaultLocale: defaultLocale,

  // Don't add locale prefix for default locale
  localePrefix: 'as-needed',
});

// Lightweight wrappers around Next.js' navigation APIs
// that will consider the routing configuration
export type Locale = (typeof locales)[number];
```

**Step 2: Commit**

```bash
git add apps/web/src/i18n/routing.ts
git commit -m "feat(web): add next-intl routing configuration"
```

---

## Task 2: Create Middleware

**Step 1: Create middleware.ts**

Create file `apps/web/src/middleware.ts`:

```typescript
import createMiddleware from 'next-intl/middleware';
import { routing } from './i18n/routing';

export default createMiddleware(routing);

export const config = {
  // Match all pathnames except for:
  // - API routes (/api/*)
  // - Next.js internals (/_next/*)
  // - Static files (files with extensions)
  // - Specific files (favicon.ico, robots.txt, etc.)
  matcher: [
    // Match all pathnames except for:
    '/((?!api|trpc|_next|_vercel|.*\\..*).*)',
    // Match pathnames within /users that might have dots
    '/([\w-]+)?/users/(.+)',
  ],
};
```

**Step 2: Commit**

```bash
git add apps/web/src/middleware.ts
git commit -m "feat(web): add next-intl middleware"
```

---

## Task 3: Update i18n Request Configuration

**Step 1: Update request.ts**

Modify `apps/web/src/i18n/request.ts`:

```typescript
import { getRequestConfig } from 'next-intl/server';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  // This typically corresponds to the `[locale]` segment
  let locale = await requestLocale;

  // Ensure that the incoming `locale` is valid
  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale;
  }

  // Load messages for the locale
  // For now, return empty messages since we use config-based translations
  // In future, you can load actual message files here
  return {
    locale,
    messages: {},
    // Optional: Configure time zone
    timeZone: 'Asia/Ho_Chi_Minh',
    // Optional: Configure now for consistent hydration
    now: new Date(),
  };
});
```

**Step 2: Commit**

```bash
git add apps/web/src/i18n/request.ts
git commit -m "feat(web): update i18n request configuration"
```

---

## Task 4: Update Next.js Configuration

**Step 1: Update next.config.ts with next-intl plugin**

Modify `apps/web/next.config.ts`:

```typescript
import type { NextConfig } from "next";
import { withContentCollections } from "@content-collections/next";
import createNextIntlPlugin from 'next-intl/plugin';

const nextConfig: NextConfig = {
  // Enable Turbopack by default (stable in Next.js 16)

  // Cache Components - explicit caching model for Next.js 16
  cacheComponents: true,

  // React Compiler (stable in Next.js 16)
  reactCompiler: true,

  // TypeScript
  typescript: {
    ignoreBuildErrors: true,
  },

  // Images
  images: {
    formats: ["image/avif", "image/webp"],
  },

  // Experimental features for performance
  experimental: {
    turbopackFileSystemCacheForBuild: true,
  },
};

// Create next-intl plugin with custom request config path
const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

// Compose plugins: withNextIntl -> withContentCollections -> nextConfig
export default withContentCollections(withNextIntl(nextConfig));
```

**Step 2: Commit**

```bash
git add apps/web/next.config.ts
git commit -m "feat(web): add next-intl plugin to next.config.ts"
```

---

## Task 5: Update Navigation Utilities

**Step 1: Update src/lib/core/navigation.ts**

The existing file creates navigation from next-intl. Update if needed:

```typescript
import { createNavigation } from 'next-intl/navigation';
import { routing } from '@/i18n/routing';

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);
```

**Step 2: Update proxy.ts if needed**

Check `src/lib/core/proxy.ts` and update imports:

```typescript
import { routing } from '@/i18n/routing';
import createMiddleware from 'next-intl/middleware';

const intlMiddleware = createMiddleware(routing);

// ... rest of proxy logic
```

**Step 3: Commit**

```bash
git add apps/web/src/lib/core/navigation.ts apps/web/src/lib/core/proxy.ts
git commit -m "refactor(web): update navigation utilities for next-intl"
```

---

## Task 6: Update Layout NextIntlClientProvider

**Step 1: Update [locale]/layout.tsx**

Ensure NextIntlClientProvider gets messages:

```typescript
import { getMessages } from 'next-intl/server';

export default async function RootLayout(props: {
  params: Promise<{ locale: string }>
  children: React.ReactNode
}) {
  const params = await props.params;
  const locale = (params.locale as LocaleOptions) || defaultLocale;
  
  setRequestLocale(locale);
  
  // Get messages for the locale
  const messages = await getMessages();
  
  const fontSans = await getSansFont();
  
  return (
    <html lang={locale} suppressHydrationWarning>
      {/* ... */}
      <body>
        <QueryProvider>
          <NextIntlClientProvider
            locale={locale}
            messages={messages}
            timeZone="Asia/Ho_Chi_Minh"
            now={new Date()}
          >
            {/* ... */}
          </NextIntlClientProvider>
        </QueryProvider>
      </body>
    </html>
  );
}
```

**Step 2: Commit**

```bash
git add apps/web/src/app/[locale]/layout.tsx
git commit -m "feat(web): update layout with getMessages for next-intl"
```

---

## Task 7: Add setRequestLocale to All Pages

**Step 1: Add setRequestLocale to enable static rendering**

Every page and layout inside `[locale]` should call `setRequestLocale`:

```typescript
import { setRequestLocale } from 'next-intl/server';

export default async function Page({ params }: Props) {
  const { locale } = await params;
  setRequestLocale(locale);
  
  // ... rest of component
}
```

**Step 2: Update all pages**

Files to update:
- `src/app/[locale]/page.tsx`
- `src/app/[locale]/blog/layout.tsx`
- `src/app/[locale]/blog/[[...slug]]/page.tsx`
- `src/app/[locale]/docs/layout.tsx`
- `src/app/[locale]/docs/[[...slug]]/page.tsx`
- `src/app/[locale]/demo/page.tsx`

**Step 3: Commit**

```bash
git add apps/web/src/app/[locale]/
git commit -m "feat(web): add setRequestLocale to all pages for static rendering"
```

---

## Checklist

- [ ] routing.ts created with locale configuration
- [ ] middleware.ts created with correct matcher
- [ ] request.ts updated for next-intl
- [ ] next.config.ts has next-intl plugin
- [ ] navigation.ts updated
- [ ] Layout has NextIntlClientProvider with messages
- [ ] All pages call setRequestLocale
- [ ] Locale switching works correctly
- [ ] Static generation works with generateStaticParams

---

## Troubleshooting

### If middleware not working:
1. Check matcher pattern in middleware.ts
2. Verify middleware.ts is in src/ root (not app/)
3. Check middleware exports default correctly

### If translations not loading:
1. Verify request.ts path in next.config.ts
2. Check getMessages() is called in layout
3. Verify locale param is being passed correctly

### If hydration errors occur:
1. Add `now={new Date()}` to NextIntlClientProvider
2. Add `timeZone` prop to ensure consistency
3. Check server/client locale match
